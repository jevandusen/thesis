function updateHaystack(e){haystack=[],d3.json("js/data/search_terms.json",function(t){"Stories"===e?t=t.filter(function(e){return"story"===e.type}):"Schools"===e?t=t.filter(function(e){return"school"===e.type}):"Reservations, Tribes, and Bands"===e&&(t=t.filter(function(e){return"reservation"===e.type}));for(var o=0;o<t.length;o++)haystack.push(t[o])})}function runSearch(e){var t=$(".cd-search-suggestions"),o=$(".o1"),s=$(".o2"),i=$(".o3"),l=$(".o1A"),n=$(".o2A"),a=$(".o3A"),c=$(".o1h"),r=$(".o2h"),d=$(".o3h"),p=$(".o1Sh"),y=$(".o2Sh"),h=$(".o3Sh"),u=$(".o1I"),m=$(".o2I"),g=$(".o3I"),f=$(".o1Info"),v=$(".o2Info"),S=$(".o3Info");t.removeClass("cd-search-suggestionsInvisible"),t.addClass("cd-search-suggestionsVisible");var T={shouldSort:!0,includeScore:!0,threshold:.6,location:0,distance:100,maxPatternLength:32,minMatchCharLength:3,keys:["name","location"]},A=new Fuse(haystack,T),k=A.search(e),b,C,w;"school"===k[0].type&&"TRUE"===k[0].photo?b="images/schoolPhotos/"+k[0].id+".jpg":"story"===k[0].type&&"TRUE"===k[0].photo&&(b="js/data/stories/images/"+k[0].id+".png"),"school"===k[1].type&&"TRUE"===k[1].photo?C="images/schoolPhotos/"+k[1].id+".jpg":"story"===k[1].type&&"TRUE"===k[1].photo&&(C="js/data/stories/images/"+k[1].id+".png"),"school"===k[2].type&&"TRUE"===k[2].photo?w="images/schoolPhotos/"+k[2].id+".jpg":"story"===k[2].type&&"TRUE"===k[2].photo&&(w="js/data/stories/images/"+k[2].id+".png");var x=[k[0].id,k[0].name,k[0].type,k[0].lat,k[0].lng],I=[k[1].id,k[1].name,k[1].type,k[1].lat,k[1].lng],E=[k[2].id,k[2].name,k[2].type,k[2].lat,k[2].lng];c.text(k[0].name),p.text(k[0].type.replace("story","Residential School Survivor").replace("school","Residential School").replace("reservation","Reserve/Band/Tribe")),u.html("<div class='oI' style='background-image: url("+b+")'></div>"),f.text(k[0].location),l.text(x),r.text(k[1].name),y.text(k[1].type.replace("story","Residential School Survivor").replace("school","Residential School").replace("reservation","Reserve/Band/Tribe")),m.html("<div class='oI' style='background-image: url("+C+")'></div>"),v.text(k[1].location),n.text(I),d.text(k[2].name),h.text(k[2].type.replace("story","Residential School Survivor").replace("school","Residential School").replace("reservation","Reserve/Band/Tribe")),g.html("<div class='oI' style='background-image: url("+w+")'></div>"),S.text(k[2].location),a.text(E)}function optionClick(e,t,o,s,i){if("story"===o){drawStory(e),pageSix(t);var l=document.getElementById("p5");zenscroll.to(l)}else if("none"===mapStatus||"zoomedIn"===mapStatus){map.flyTo({center:[i,s],zoom:10,bearing:0,speed:100,curve:1,easing:function(e){return e}}),"school"===o?sSearch(e):rSearch(e);var l=document.getElementById("p6");zenscroll.to(l)}else if("zoomedOut"===mapStatus){"school"===o?sSearch(e):rSearch(e);var l=document.getElementById("tMap1_reserves");zenscroll.to(l)}else if("reserves"===mapStatus){"school"===o?sSearch(e):rSearch(e);var l=document.getElementById("tMap1_connections");zenscroll.to(l)}else if("connections"===mapStatus){"school"===o?sSearch(e):rSearch(e);var l=document.getElementById("tMap1_connections");zenscroll.to(l)}}function rSearch(e){d3.selectAll(".rDot").style("opacity",".025").style("fill","#333"),d3.select("#rDot-"+e).style("opacity",".75").style("fill",orange),d3.selectAll(".rTooltip").style("opacity","0"),d3.selectAll(".dot").style("opacity",".25").style("fill",orange),d3.selectAll(".conn").style("opacity",".05"),d3.selectAll(".sTooltip").style("opacity",0),d3.selectAll(".sTooltipB").style("opacity",0),d3.selectAll(".sTooltip2").style("opacity",0),d3.selectAll(".sTooltip2B").style("opacity",0),d3.selectAll("#sTip-"+e).style("opacity",0),d3.select("#l2").transition().duration(500).ease(d3.easeLinear).style("opacity",.75),d3.select(".legendIn-bottom").transition().delay(500).duration(500).ease(d3.easeLinear).style("opacity",.75),d3.selectAll("#rTip-"+e).style("opacity",0),"zoomedIn"===mapStatus||"none"===mapStatus?d3.selectAll("#rTip-"+e).style("opacity",0):d3.selectAll("#rTip-"+e).style("opacity",1)}function sSearch(e){d3.selectAll(".dot").style("opacity",".25").style("fill",orange),d3.select("#dot-"+e).style("opacity",1).style("fill","#333"),d3.selectAll(".sTooltip").style("opacity",0),d3.selectAll(".sTooltipB").style("opacity",0),d3.selectAll(".sTooltip2").style("opacity",0),d3.selectAll(".sTooltip2B").style("opacity",0),d3.selectAll(".rDot").style("opacity",".025").style("fill","#333"),d3.selectAll(".rTooltip").style("opacity","0"),d3.selectAll(".conn").style("opacity",".05"),d3.selectAll("#sTip-"+e).style("opacity",0),d3.selectAll("#rTip-"+e).style("opacity",0),"zoomedIn"===mapStatus||"none"===mapStatus?d3.selectAll("#sTip-"+e).style("opacity",0):d3.selectAll("#sTip-"+e).style("opacity",1)}var category="All Categories",haystack=[];jQuery(document).ready(function($){function e(){return window.getComputedStyle(y.get(0),"::before").getPropertyValue("content").replace(/"/g,"").replace(/'/g,"")}function t(){i||(i=!0,window.requestAnimationFrame?window.requestAnimationFrame(o):setTimeout(o,300))}function o(){var t=e();if("desktop"==t&&0==p.siblings(".cd-main-search").length)a.detach().insertBefore(p),l.detach().insertBefore(a).find(".cd-serch-wrapper").remove();else if("mobile"==t&&0!=y.children(".cd-main-nav-wrapper").length){l.detach().insertAfter(".cd-main-content");var o=$('<li class="cd-serch-wrapper"></li>');a.detach().appendTo(o),o.appendTo(n)}i=!1}function s(){r.removeClass("search-form-visible"),a.removeClass("is-visible"),d.removeClass("search-form-visible")}updateHaystack(category);var i=!1,l=$(".cd-main-nav-wrapper"),n=l.children(".cd-main-nav"),a=$(".cd-main-search"),c=$(".cd-main-content"),r=$(".cd-search-trigger"),d=$(".cd-cover-layer"),p=$(".cd-nav-trigger"),y=$(".cd-main-header"),h=$(".cd-search-suggestions");!Modernizr.testProp("pointerEvents")&&$("html").addClass("no-pointerevents"),o(),$(window).on("resize",t),r.on("click",function(e){e.preventDefault(),r.hasClass("search-form-visible")?a.find("form").submit():($(".cd-main-header").addClass("cd-main-header-open"),$(".newLinks").addClass("newLinksVisible"),r.addClass("search-form-visible"),d.addClass("search-form-visible"),a.addClass("is-visible").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){a.find('input[type="search"]').focus().end().off("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend")}))}),a.on("click",".close",function(){s(),$(".cd-main-header").removeClass("cd-main-header-open"),$(".cd-search-suggestions").removeClass("cd-search-suggestionsVisible"),$(".cd-search-suggestions").addClass("cd-search-suggestionsInvisible"),$(".newLinks").removeClass("newLinksVisible")}),d.on("click",function(){s()}),$(document).keyup(function(e){"27"==e.which&&s()}),a.on("change","select",function(){a.find(".selected-value").text($(this).children("option:selected").text()),category=$(this).children("option:selected").text(),updateHaystack(category)}),a.keyup(function(){var e=$(this).find("input").val();$(".newLinks").removeClass("newLinksVisible"),runSearch(e)})}),$(".o1").on("click",function(e){var t=$(this).find(".oA").text().split(",");optionClick(t[0],t[1],t[2],t[3],t[4])}),$(".o2").on("click",function(e){var t=$(this).find(".oA").text().split(",");optionClick(t[0],t[1],t[2],t[3],t[4])}),$(".o3").on("click",function(e){var t=$(this).find(".oA").text().split(",");optionClick(t[0],t[1],t[2],t[3],t[4])});