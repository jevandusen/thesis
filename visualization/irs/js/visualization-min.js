function getD3(){var e=document.body.getBoundingClientRect(),t=map.getCenter(),o=map.getZoom(),r=256/Math.PI*Math.pow(2,o);return d3.geoMercator().center([t.lng,t.lat]).translate([e.width/2,e.height/2]).scale(r)}function drawStory(e){d3.select(".storyTime").remove(),d3.json("js/data/stories/stories.json",function(t){var o=t.stories.filter(function(t){return t.id===e});o=o[0];var r=o.name,n=o.bio,s=o.schoolBio;storySelected=o.name+" was",pageSix(r);var l=d3.select("#storyTime").append("div").attr("class","storyTime").html("<div id='storyName'></div><div id='storyBio'></div><div id='storySchoolBio'></div><div id='storyStories'></div>"),a=d3.select("#storyName").append("h1").attr("class","name").html("<span class='storyName'>"+r+"</span>"),i=d3.select("#storyBio").append("div").attr("class","bio").html("<p>"+n+"</p>"),c=d3.select("#storySchoolBio").append("div").attr("class","schoolBio").html("<p>"+s+"</p>");storyName_p=new ScrollMagic.Scene({triggerElement:"#storyName",duration:"100%"}).offset(document.getElementById("storyName").offsetHeight/2+"px").setPin("#storyName").addTo(controller),storyBio_p=new ScrollMagic.Scene({triggerElement:"#storyBio",duration:"100%"}).offset(document.getElementById("storyBio").offsetHeight/2+"px").setPin("#storyBio").addTo(controller),storySchoolBio_p=new ScrollMagic.Scene({triggerElement:"#storySchoolBio",duration:"100%"}).offset(document.getElementById("storySchoolBio").offsetHeight/2+"px").setPin("#storySchoolBio").addTo(controller);for(var d=TweenMax.to("#storyName",.5,{opacity:"0"}),p=TweenMax.to("#storyBio",.5,{opacity:"0"}),y=TweenMax.to("#storySchoolBio",.5,{opacity:"0"}),g=new ScrollMagic.Scene({triggerElement:"#storyBio"}).triggerHook("onEnter").setTween(d).addTo(controller),u=new ScrollMagic.Scene({triggerElement:"#storySchoolBio"}).triggerHook("onEnter").setTween(p).addTo(controller),m=new ScrollMagic.Scene({triggerElement:"#storyStories"}).triggerHook("onEnter").setTween(y).addTo(controller),f=0;f<o.story.length;f++){var h=d3.select("#storyStories").append("div").attr("class","storyStories").attr("id","story-"+f);if(""===o.story[f].quote){var v=o.story[f].section,w=o.story[f].pre;h.html("<p class='story-section'>"+v+"</p><p class='story-quote'>"+w+"</p>")}else{var v=o.story[f].section,w=o.story[f].pre,S=o.story[f].quote,T=RiString(S),x=T.words(),M=T.pos();h.html("<p class='story-section'>"+v+"</p><p class='story-pre'>"+w+"</p><p class='story-quote'>&ldquo;<span id='story-quote-"+f+"'></span>&rdquo;</p>")}for(var D=0;D<x.length;D++)if(/[,.?\-]/.test(x[D+1]))var A=d3.select("#story-quote-"+f).append("span").attr("id","quote-"+D).attr("class","pos-"+M[D]).html(x[D]);else var A=d3.select("#story-quote-"+f).append("span").attr("id","quote-"+D).attr("class","pos-"+M[D]).html(x[D]+" ")}for(var f=0;f<o.story.length-1;f++){var j=f+1,L=new ScrollMagic.Scene({triggerElement:"#story-"+f,duration:"100%"}).offset(document.getElementById("story-"+f).offsetHeight/2+"px").setPin("#story-"+f).addTo(controller),P=TweenMax.to("#story-"+f,.5,{opacity:"0"});if(f<o.story.length)var b=new ScrollMagic.Scene({triggerElement:"#story-"+j}).triggerHook("onEnter").setTween(P).addTo(controller)}var k=o.story.length-1;storyStory_last_p=new ScrollMagic.Scene({triggerElement:"#story-"+k,duration:"100%"}).offset(document.getElementById("story-"+k).offsetHeight/2+"px").setPin("#story-"+k).addTo(controller);var P=TweenMax.to("#story-"+k,.5,{opacity:"0"}),b=new ScrollMagic.Scene({triggerElement:"#p6"}).triggerHook("onEnter").setTween(P).addTo(controller)})}function pageSix(e){d3.selectAll(".overlay").remove(),d3.selectAll(".dot").classed("schoolMarker",!0).style("opacity",1),d3.selectAll(".label").classed("schoolLabel",!0).style("opacity",1);var t=d3.select("#oneof").append("div").attr("class","overlay").html(storySelected+" one of an estimated <span class='orange'>150,000</span> Aboriginal children to attend a residential school in Canada."),o=d3.select("#thismany").append("div").attr("class","overlay").html("There were <span class='orange'>132</span> schools located throughout the country."),r=d3.select("#fromreserves").append("div").attr("class","overlay").html("Students were drawn from reserves, bands, and tribes all over Canada, some as far away as <span class='orange'>8000km</span>."),n=new ScrollMagic.Controller;TweenLite.defaultOverwrite=!1,d3.json("js/data/stories/stories.json",function(t){t=t.stories.filter(function(t){return t.name===e}),t=t[0],map.flyTo({center:[t.latLng.lng,t.latLng.lat],zoom:t.zoom,bearing:0,speed:100,curve:1,easing:function(e){return e}}),d3.select("#dot-"+t.schoolID).classed("schoolMarker",!1),d3.select("#label-"+t.schoolID).classed("schoolLabel",!1),new ScrollMagic.Scene({triggerElement:"#tMap1_zo"}).addTo(n).on("progress",function(e){"FORWARD"===e.scrollDirection?(d3.selectAll(".schoolLabel").style("opacity","0"),d3.selectAll(".schoolMarker").style("opacity","0"),map.flyTo({center:[-100,58],zoom:4,bearing:0,speed:2,curve:1,easing:function(e){return e}})):(d3.select("#dot-"+t.schoolID).style("opacity",1),d3.select("#label-"+t.schoolID).style("opacity",1),map.flyTo({center:[t.latLng.lng,t.latLng.lat],zoom:t.zoom,bearing:0,speed:5,curve:1,easing:function(e){return e}}))}),new ScrollMagic.Scene({triggerElement:"#tMap1_irs"}).addTo(n).on("progress",function(e){"FORWARD"===e.scrollDirection?(d3.selectAll(".schoolMarker").transition().duration(600).ease(d3.easeLinear).style("opacity",1),d3.select("#label-"+t.schoolID).transition().duration(600).ease(d3.easeLinear).style("opacity",0)):(d3.selectAll(".schoolMarker").transition().duration(600).ease(d3.easeLinear).style("opacity",0),d3.select("#label-"+t.schoolID).transition().duration(600).ease(d3.easeLinear).style("opacity",1))}),new ScrollMagic.Scene({triggerElement:"#tMap1_reserves"}).addTo(n).on("progress",function(e){"FORWARD"===e.scrollDirection?d3.selectAll(".reserveDot").style("display","block").transition().duration(600).ease(d3.easeLinear).style("opacity",.1):(d3.selectAll(".reserveDot").transition().duration(600).ease(d3.easeLinear).style("opacity",0),d3.selectAll(".reserveDot").transition().delay(600).style("display","none"))});var o=new ScrollMagic.Scene({triggerElement:"#oneof",duration:"150%"}).offset(document.getElementById("oneof").offsetHeight/2+"px").setPin("#oneof").addTo(n),r=TweenMax.to("#oneof",.5,{opacity:"0"}),s=new ScrollMagic.Scene({triggerElement:"#thismany"}).triggerHook("onEnter").setTween(r).addTo(n),l=new ScrollMagic.Scene({triggerElement:"#thismany",duration:"150%"}).offset(document.getElementById("thismany").offsetHeight/2+"px").setPin("#thismany").addTo(n),a=TweenMax.to("#thismany",.5,{opacity:"0"}),i=new ScrollMagic.Scene({triggerElement:"#fromreserves"}).triggerHook("onEnter").setTween(a).addTo(n),c=new ScrollMagic.Scene({triggerElement:"#fromreserves",duration:"100%"}).offset(document.getElementById("fromreserves").offsetHeight/2+"px").setPin("#fromreserves").addTo(n),d=TweenMax.to("#fromreserves",.5,{opacity:"0"}),p=new ScrollMagic.Scene({triggerElement:"#tMap1_connections"}).triggerHook("onLeave").setTween(d).addTo(n)})}var storyID="aelias";window.onload=drawStory(storyID);var orange="#f15a24",controller=new ScrollMagic.Controller;TweenLite.defaultOverwrite=!1;var map1=d3.select("#map1_cont").append("div").attr("class","map").attr("id","map");d3.select("#map").style("height",window.innerHeight+"px").style("width",window.innerWidth+"px"),mapboxgl.accessToken="pk.eyJ1Ijoic3ZpY2thcnMiLCJhIjoiY2l1aW5saDhkMDAwMTNvbDdmcTlncnp1cyJ9.wIpJKF-DW1C2uPgKnUtNWg";var map=new mapboxgl.Map({container:"map",style:"mapbox://styles/svickars/cj15o81vo00212rqu9mw0wgkp",center:[-92.01173055555556,50.12052777777778],zoom:9});map.scrollZoom.disable(),map.dragRotate.disable(),map.addControl(new mapboxgl.Navigation);var map1_p=new ScrollMagic.Scene({triggerElement:"#tMap1_p",duration:"800%"}).triggerHook("onLeave").setPin("#map1_cont").addTo(controller),container=map.getCanvasContainer(),svg=d3.select(container).append("svg"),g=svg.append("g"),d3Projection=getD3(),path=d3.geoPath();d3.json("js/data/locations.json",function(e){function t(){d3Projection=getD3(),path.projection(d3Projection),a.attr("cx",function(e){return d3Projection([e.longitude,e.latitude])[0]}).attr("cy",function(e){return d3Projection([e.longitude,e.latitude])[1]}),d.attr("x",function(e){return d3Projection([e.longitude,e.latitude])[0]}).attr("y",function(e){return d3Projection([e.longitude,e.latitude])[1]}),p.attr("x",function(e){return d3Projection([e.longitude,e.latitude])[0]}).attr("y",function(e){return d3Projection([e.longitude,e.latitude])[1]}),i.attr("x",function(e){return d3Projection([e.longitude,e.latitude])[0]}).attr("y",function(e){return d3Projection([e.longitude,e.latitude])[1]}),l.attr("cx",function(e){return d3Projection([e.lng,e.lat])[0]}).attr("cy",function(e){return d3Projection([e.lng,e.lat])[1]}),c.attr("x",function(e){return d3Projection([e.lng,e.lat])[0]}).attr("y",function(e){return d3Projection([e.lng,e.lat])[1]})}function o(e){d3.select("#dot-"+e.schoolID).classed("schoolMarker",!1),d3.selectAll(".schoolMarker").style("opacity",".25"),d3.select("#dot-"+e.schoolID).style("fill","#333").style("opacity",1),d3.selectAll("#sTip-"+e.schoolID).style("opacity","1.0"),""===e.listConnections||(d3.selectAll(e.class).classed("reserveDot",!1).classed("connection",!1),d3.selectAll(e.class).style("opacity",".6")),d3.selectAll(".reserveDot").style("opacity",".05"),d3.selectAll(".connection").style("opacity",".05")}function r(e){d3.select("#rDot-"+e.id).classed("reserveDot",!1),d3.selectAll(".reserveDot").style("opacity",".025").style("fill","#333"),d3.selectAll("#rTip-"+e.id).style("opacity","1.0"),""===e.listConnections||(d3.selectAll(e.class).classed("schoolMarker",!1).classed("connection",!1),d3.selectAll(e.class).style("opacity","1"),d3.select("#rDot-"+e.id).style("opacity",.25)),d3.selectAll(".schoolMarker").style("opacity",".25"),d3.selectAll(".connection").style("opacity",".05")}function n(e){d3.selectAll(".dot").classed("schoolMarker",!0),d3.selectAll(".schoolMarker").style("fill",orange).style("opacity","1"),d3.selectAll("#sTip-"+e.schoolID).style("opacity","0"),d3.selectAll(".sTooltip").style("opacity","0"),d3.selectAll(".sTooltip2").style("opacity","0"),d3.selectAll(".rDot").classed("reserveDot",!0),d3.selectAll(".reserveDot").style("opacity",".1"),d3.selectAll(".conn").classed("connection",!0),d3.selectAll(".connection").style("opacity","0.25")}function s(e){d3.selectAll(".rDot").classed("reserveDot",!0),d3.selectAll(".reserveDot").style("opacity",".1"),d3.selectAll(".dot").classed("schoolMarker",!0),d3.selectAll(".schoolMarker").style("opacity","1"),d3.selectAll(".conn").classed("connection",!0),d3.selectAll(".connection").style("opacity","0.25"),d3.selectAll("#rTip-"+e.id).style("opacity","0"),d3.selectAll(".rTooltip").style("opacity","0")}var l=g.selectAll(".rDot").data(e.reservations).enter().append("circle",".rDot").attr("pointer-events","visible").attr("class",function(e){return"rDot reserveDot "+e.listConnections}).attr("id",function(e){return"rDot-"+e.id}).style("stroke","none").style("display","none").style("opacity","0").style("fill","#333").attr("r",15).on("mouseover",r).on("mouseout",s),a=g.selectAll(".sCircle").data(e.schools).enter().append("circle",".sCircle").attr("class",function(e){return"schoolMarker dot "+e.listConnections}).attr("pointer-events","visible").attr("id",function(e){return"dot-"+e.schoolID}).style("stroke","none").style("opacity",1).style("fill",orange).attr("r",5).on("mouseover",o).on("mouseout",n),i=g.selectAll("text").data(e.schools).enter().append("text").attr("class","label schoolLabel").attr("id",function(e){return"label-"+e.schoolID}).attr("dy","6px").attr("dx","10px").text(function(e){return e.locationName+" "+e.title}),c=g.selectAll(".rTip").data(e.reservations).enter().append("text",".rtip").attr("class","rTooltip").attr("id",function(e){return"rTip-"+e.id}).attr("dx","20px").attr("dy","5px").text(function(e){return e.reserve}),d=g.selectAll(".sTip").data(e.schools).enter().append("text",".stip").attr("class","sTooltip").attr("id",function(e){return"sTip-"+e.schoolID}).attr("dx","9px").attr("dy","5px").text(function(e){return e.locationName+" "+e.title}),p=g.selectAll(".sTip2").data(e.schools).enter().append("text",".stip2").attr("class","sTooltip2").attr("id",function(e){return"sTip-"+e.schoolID}).attr("dx","9px").attr("dy","19px").text(function(e){return e.start+" - "+e.end});map.on("viewreset",function(){t()}),map.on("move",function(){t()}),t()}),d3.json("js/data/connections.json",function(e){function t(){d3Projection=getD3(),path.projection(d3Projection),!1===r?o.attr("x1",function(e){return d3Projection([e.sLng,e.sLat])[0]}).attr("y1",function(e){return d3Projection([e.sLng,e.sLat])[1]}).attr("x2",function(e){return d3Projection([e.sLng,e.sLat])[0]}).attr("y2",function(e){return d3Projection([e.sLng,e.sLat])[1]}):o.attr("x1",function(e){return d3Projection([e.sLng,e.sLat])[0]}).attr("y1",function(e){return d3Projection([e.sLng,e.sLat])[1]}).attr("x2",function(e){return d3Projection([e.eLng,e.eLat])[0]}).attr("y2",function(e){return d3Projection([e.eLng,e.eLat])[1]})}var o=g.selectAll("line").data(e).enter().append("line").attr("class",function(e){return"connection conn "+e.id}).attr("id",function(e){return"conn-"+e.id}).style("stroke",orange).style("opacity",.25),r=!1;new ScrollMagic.Scene({triggerElement:"#tMap1_connections"}).addTo(controller).on("progress",function(e){"FORWARD"===e.scrollDirection?(r=!0,o.transition().duration(1500).attr("x2",function(e){return d3Projection([e.eLng,e.eLat])[0]}).attr("y2",function(e){return d3Projection([e.eLng,e.eLat])[1]})):(r=!1,o.transition().duration(1500).attr("x2",function(e){return d3Projection([e.sLng,e.sLat])[0]}).attr("y2",function(e){return d3Projection([e.sLng,e.sLat])[1]}))}),map.on("viewreset",function(){t()}),map.on("move",function(){t()}),map.on("rotate",function(){t()}),t()}),jQuery("#stories-select").draggable({axis:"x",cursor:"move",containment:"stories"});var storiesSelectScroll=(new TimelineMax).to("#stories-select",1,{x:"-50%",delay:.25}),p4pin=new ScrollMagic.Scene({triggerElement:"#p4",triggerHook:"onLeave",duration:"200%"}).setPin("#p4").setTween(storiesSelectScroll).addTo(controller);d3.json("js/data/stories/stories.json",function(e){for(var t=0;t<e.stories.length;t++){var o=d3.select("#stories-select").append("div").attr("class","story-option-container").attr("id",e.stories[t].id).on("click",function(e,t){storyID=d3.select(this).attr("id"),d3.selectAll(".story-option-container").transition().duration(200).ease(d3.easeLinear).style("opacity",.1),d3.select("#"+storyID).transition().duration(200).ease(d3.easeLinear).style("opacity",1),drawStory(storyID),p4pin.destroy()});d3.select("#"+e.stories[t].id).append("div").attr("class","story-option-circle").attr("id","story-option"+t).style("background","linear-gradient(rgba(241, 90, 36, 0.25),rgba(241, 90, 36, 0.25)), url('js/data/stories/images/"+e.stories[t].picture+"'), rgb(241, 90, 36)").style("background-size","10em");d3.select("#"+e.stories[t].id).append("div").attr("class","story-label").html("<p class='story-option-name'>"+e.stories[t].name+"</p><p class='story-option-quote'>&ldquo;"+e.stories[t].pull+"&rdquo;</p>")}});