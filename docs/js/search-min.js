function updateHaystack(e){haystack=[],d3.json("js/data/search_terms.json",function(t){"Stories"===e?t=t.filter(function(e){return"story"===e.type}):"Schools"===e?t=t.filter(function(e){return"school"===e.type}):"Reservations"===e&&(t=t.filter(function(e){return"reservation"===e.type}));for(var s=0;s<t.length;s++)haystack.push(t[s])})}function runSearch(e){var t=$(".cd-search-suggestions"),s=$(".o1"),o=$(".o2"),i=$(".o3"),l=$(".o1A"),n=$(".o2A"),a=$(".o3A"),c=$(".o1h"),r=$(".o2h"),d=$(".o3h"),p=$(".o1Sh"),h=$(".o2Sh"),y=$(".o3Sh"),u=$(".o1I"),m=$(".o2I"),g=$(".o3I"),v=$(".o1Info"),f=$(".o2Info"),b=$(".o3Info");t.removeClass("cd-search-suggestionsInvisible"),t.addClass("cd-search-suggestionsVisible");var S={shouldSort:!0,includeScore:!0,threshold:.6,location:0,distance:100,maxPatternLength:32,minMatchCharLength:3,keys:["name","location"]},k=new Fuse(haystack,S),T=k.search(e),C,A,w;"school"===T[0].type&&"TRUE"===T[0].photo?C="images/schoolPhotos/"+T[0].id+".jpg":"story"===T[0].type&&"TRUE"===T[0].photo&&(C="js/data/stories/images/"+T[0].id+".png"),"school"===T[1].type&&"TRUE"===T[1].photo?A="images/schoolPhotos/"+T[1].id+".jpg":"story"===T[1].type&&"TRUE"===T[1].photo&&(A="js/data/stories/images/"+T[1].id+".png"),"school"===T[2].type&&"TRUE"===T[2].photo?w="images/schoolPhotos/"+T[2].id+".jpg":"story"===T[2].type&&"TRUE"===T[2].photo&&(w="js/data/stories/images/"+T[2].id+".png");var x=[T[0].id,T[0].name,T[0].type,T[0].lat,T[0].lng],I=[T[1].id,T[1].name,T[1].type,T[1].lat,T[1].lng],E=[T[2].id,T[2].name,T[2].type,T[2].lat,T[2].lng];c.text(T[0].name),p.text(T[0].type.replace("story","Residential School Survivor").replace("school","Residential School").replace("reservation","Reserve/Band/Tribe")),u.html("<div class='oI' style='background-image: url("+C+")'></div>"),v.text(T[0].location),l.text(x),r.text(T[1].name),h.text(T[1].type.replace("story","Residential School Survivor").replace("school","Residential School").replace("reservation","Reserve/Band/Tribe")),m.html("<div class='oI' style='background-image: url("+A+")'></div>"),f.text(T[1].location),n.text(I),d.text(T[2].name),y.text(T[2].type.replace("story","Residential School Survivor").replace("school","Residential School").replace("reservation","Reserve/Band/Tribe")),g.html("<div class='oI' style='background-image: url("+w+")'></div>"),b.text(T[2].location),a.text(E)}function optionClick(e,t,s,o,i){if("story"===s){drawStory(e),pageSix(t);var l=document.getElementById("p5");zenscroll.to(l)}else if("none"===mapStatus||"zoomedIn"===mapStatus){map.flyTo({center:[i,o],zoom:10,bearing:0,speed:100,curve:1,easing:function(e){return e}}),"school"===s?sSearch(e):rSearch(e);var l=document.getElementById("p6");zenscroll.to(l)}else if("zoomedOut"===mapStatus){"school"===s?sSearch(e):rSearch(e);var l=document.getElementById("tMap1_reserves");zenscroll.to(l)}else if("reserves"===mapStatus){"school"===s?sSearch(e):rSearch(e);var l=document.getElementById("tMap1_connections");zenscroll.to(l)}else if("connections"===mapStatus){"school"===s?sSearch(e):rSearch(e);var l=document.getElementById("tMap1_connections");zenscroll.to(l)}}function rSearch(e){d3.selectAll(".rDot").style("opacity",".025").style("fill","#333"),d3.select("#rDot-"+e).style("opacity",".75").style("fill",orange),d3.selectAll(".rTooltip").style("opacity","0"),d3.selectAll(".dot").style("opacity",".25").style("fill",orange),d3.selectAll(".conn").style("opacity",".05"),d3.selectAll(".sTooltip").style("opacity",0),d3.selectAll(".sTooltipB").style("opacity",0),d3.selectAll(".sTooltip2").style("opacity",0),d3.selectAll(".sTooltip2B").style("opacity",0),d3.selectAll("#sTip-"+e).style("opacity",0),d3.select("#l2").transition().duration(500).ease(d3.easeLinear).style("opacity",.75),d3.select(".legendIn-bottom").transition().delay(500).duration(500).ease(d3.easeLinear).style("opacity",.75),d3.selectAll("#rTip-"+e).style("opacity",0),"zoomedIn"===mapStatus||"none"===mapStatus?d3.selectAll("#rTip-"+e).style("opacity",0):d3.selectAll("#rTip-"+e).style("opacity",1)}function sSearch(e){d3.selectAll(".dot").style("opacity",".25").style("fill",orange),d3.select("#dot-"+e).style("opacity",1).style("fill","#333"),d3.selectAll(".sTooltip").style("opacity",0),d3.selectAll(".sTooltipB").style("opacity",0),d3.selectAll(".sTooltip2").style("opacity",0),d3.selectAll(".sTooltip2B").style("opacity",0),d3.selectAll(".rDot").style("opacity",".025").style("fill","#333"),d3.selectAll(".rTooltip").style("opacity","0"),d3.selectAll(".conn").style("opacity",".05"),d3.selectAll("#sTip-"+e).style("opacity",0),d3.selectAll("#rTip-"+e).style("opacity",0),"zoomedIn"===mapStatus||"none"===mapStatus?d3.selectAll("#sTip-"+e).style("opacity",0):d3.selectAll("#sTip-"+e).style("opacity",1)}var p1Height=$("#p1").height();$(window).scroll(function(e){var t=$(".cd-main-nav-wrapper"),s="fixed"==t.css("position");$(this).scrollTop()>p1Height&&$(".cd-main-nav-wrapper").css({display:"block"}),$(this).scrollTop()<p1Height&&$(".cd-main-nav-wrapper").css({display:"none"})});var category="All Categories",haystack=[];jQuery(document).ready(function($){function e(){return window.getComputedStyle(h.get(0),"::before").getPropertyValue("content").replace(/"/g,"").replace(/'/g,"")}function t(){i||(i=!0,window.requestAnimationFrame?window.requestAnimationFrame(s):setTimeout(s,300))}function s(){var t=e();"desktop"==t&&0==p.siblings(".cd-main-search").length?(a.detach().insertBefore(p),l.detach().insertBefore(a).find(".cd-serch-wrapper").remove()):"mobile"==t&&0!=h.children(".cd-main-nav-wrapper").length&&(a.detach().insertBefore(p),l.detach().insertBefore(a).find(".cd-serch-wrapper").remove()),i=!1}function o(){r.removeClass("search-form-visible"),a.removeClass("is-visible"),d.removeClass("search-form-visible"),$(".cd-search-suggestions").removeClass("cd-search-suggestionsVisible"),$(".cd-search-suggestions").addClass("cd-search-suggestionsInvisible"),$(".newLinks").removeClass("newLinksVisible")}updateHaystack(category);var i=!1,l=$(".cd-main-nav-wrapper"),n=l.children(".cd-main-nav"),a=$(".cd-main-search"),c=$(".cd-main-content"),r=$(".cd-search-trigger"),d=$(".cd-cover-layer"),p=$(".cd-nav-trigger"),h=$(".cd-main-header"),y=$(".cd-search-suggestions"),u=$(".credits-overlay"),m=$(".credits-trigger"),g=$(".credits-exit");!Modernizr.testProp("pointerEvents")&&$("html").addClass("no-pointerevents"),s(),$(window).on("resize",t),r.on("click",function(e){e.preventDefault(),r.hasClass("search-form-visible")?a.find("form").submit():($(".cd-main-header").addClass("cd-main-header-open"),$(".newLinks").addClass("newLinksVisible"),r.addClass("search-form-visible"),d.addClass("search-form-visible"),a.addClass("is-visible").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){a.find('input[type="search"]').focus().end().off("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend")}))}),m.on("click",function(e){e.preventDefault(),u.addClass("credits-overlay-visible"),d.addClass("search-form-visible")}),g.on("click",function(e){o(),u.removeClass("credits-overlay-visible"),d.removeClass("search-form-visible")}),a.on("click",".close",function(){o(),$(".cd-main-header").removeClass("cd-main-header-open"),$(".cd-search-suggestions").removeClass("cd-search-suggestionsVisible"),$(".cd-search-suggestions").addClass("cd-search-suggestionsInvisible"),$(".newLinks").removeClass("newLinksVisible")}),d.on("click",function(){o(),u.removeClass("credits-overlay-visible"),$(".cd-search-suggestions").removeClass("cd-search-suggestionsVisible"),$(".cd-search-suggestions").addClass("cd-search-suggestionsInvisible"),$(".newLinks").removeClass("newLinksVisible")}),$(document).keyup(function(e){"27"==e.which&&o()}),a.on("change","select",function(){a.find(".selected-value").text($(this).children("option:selected").text()),category=$(this).children("option:selected").text(),updateHaystack(category)}),a.keyup(function(){runSearch($(this).find("input").val()),$(".newLinks").removeClass("newLinksVisible")})}),$(".o1").on("click",function(e){var t=$(this).find(".oA").text().split(",");optionClick(t[0],t[1],t[2],t[3],t[4])}),$(".o2").on("click",function(e){var t=$(this).find(".oA").text().split(",");optionClick(t[0],t[1],t[2],t[3],t[4])}),$(".o3").on("click",function(e){var t=$(this).find(".oA").text().split(",");optionClick(t[0],t[1],t[2],t[3],t[4])});