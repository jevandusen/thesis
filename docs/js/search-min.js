function updateHaystack(e){haystack=[],d3.json("js/data/search_terms.json",function(s){"Stories"===e?s=s.filter(function(e){return"story"===e.type}):"Schools"===e?s=s.filter(function(e){return"school"===e.type}):"Reservations"===e&&(s=s.filter(function(e){return"reservation"===e.type}));for(var t=0;t<s.length;t++)haystack.push(s[t])})}function runSearch(e){var s=$(".cd-search-suggestions"),t=$(".o1"),o=$(".o2"),i=$(".o3"),a=$(".o1A"),l=$(".o2A"),n=$(".o3A"),c=$(".o1h"),r=$(".o2h"),d=$(".o3h"),p=$(".o1Sh"),h=$(".o2Sh"),y=$(".o3Sh"),m=$(".o1I"),u=$(".o2I"),v=$(".o3I"),g=$(".o1Info"),f=$(".o2Info"),b=$(".o3Info");s.removeClass("cd-search-suggestionsInvisible"),s.addClass("cd-search-suggestionsVisible");var S={shouldSort:!0,includeScore:!0,threshold:.6,location:0,distance:100,maxPatternLength:32,minMatchCharLength:3,keys:["name","location"]},k=new Fuse(haystack,S),C=k.search(e),T,A,w;"school"===C[0].type&&"TRUE"===C[0].photo?T="images/schoolPhotos/"+C[0].id+".jpg":"story"===C[0].type&&"TRUE"===C[0].photo&&(T="js/data/stories/images/"+C[0].id+".png"),"school"===C[1].type&&"TRUE"===C[1].photo?A="images/schoolPhotos/"+C[1].id+".jpg":"story"===C[1].type&&"TRUE"===C[1].photo&&(A="js/data/stories/images/"+C[1].id+".png"),"school"===C[2].type&&"TRUE"===C[2].photo?w="images/schoolPhotos/"+C[2].id+".jpg":"story"===C[2].type&&"TRUE"===C[2].photo&&(w="js/data/stories/images/"+C[2].id+".png");var x=[C[0].id,C[0].name,C[0].type,C[0].lat,C[0].lng],I=[C[1].id,C[1].name,C[1].type,C[1].lat,C[1].lng],E=[C[2].id,C[2].name,C[2].type,C[2].lat,C[2].lng];c.text(C[0].name),p.text(C[0].type.replace("story","Residential School Survivor").replace("school","Residential School").replace("reservation","Reserve/Band/Tribe")),m.html("<div class='oI' style='background-image: url("+T+")'></div>"),g.text(C[0].location),a.text(x),r.text(C[1].name),h.text(C[1].type.replace("story","Residential School Survivor").replace("school","Residential School").replace("reservation","Reserve/Band/Tribe")),u.html("<div class='oI' style='background-image: url("+A+")'></div>"),f.text(C[1].location),l.text(I),d.text(C[2].name),y.text(C[2].type.replace("story","Residential School Survivor").replace("school","Residential School").replace("reservation","Reserve/Band/Tribe")),v.html("<div class='oI' style='background-image: url("+w+")'></div>"),b.text(C[2].location),n.text(E)}function optionClick(e,s,t,o,i){if("story"===t){drawStory(e),pageSix(s);var a=document.getElementById("p5");zenscroll.to(a)}else if("none"===mapStatus||"zoomedIn"===mapStatus){map.flyTo({center:[i,o],zoom:10,bearing:0,speed:100,curve:1,easing:function(e){return e}}),"school"===t?sSearch(e):rSearch(e);var a=document.getElementById("p6");zenscroll.to(a)}else if("zoomedOut"===mapStatus){"school"===t?sSearch(e):rSearch(e);var a=document.getElementById("tMap1_reserves");zenscroll.to(a)}else if("reserves"===mapStatus){"school"===t?sSearch(e):rSearch(e);var a=document.getElementById("tMap1_connections");zenscroll.to(a)}else if("connections"===mapStatus){"school"===t?sSearch(e):rSearch(e);var a=document.getElementById("tMap1_connections");zenscroll.to(a)}}function rSearch(e){d3.selectAll(".rDot").style("opacity",".025").style("fill","#333"),d3.select("#rDot-"+e).style("opacity",".75").style("fill",orange),d3.selectAll(".rTooltip").style("opacity","0"),d3.selectAll(".dot").style("opacity",".25").style("fill",orange),d3.selectAll(".conn").style("opacity",".05"),d3.selectAll(".sTooltip").style("opacity",0),d3.selectAll(".sTooltipB").style("opacity",0),d3.selectAll(".sTooltip2").style("opacity",0),d3.selectAll(".sTooltip2B").style("opacity",0),d3.selectAll("#sTip-"+e).style("opacity",0),d3.select("#l2").transition().duration(500).ease(d3.easeLinear).style("opacity",.75),d3.select(".legendIn-bottom").transition().delay(500).duration(500).ease(d3.easeLinear).style("opacity",.75),d3.selectAll("#rTip-"+e).style("opacity",0),"zoomedIn"===mapStatus||"none"===mapStatus?d3.selectAll("#rTip-"+e).style("opacity",0):d3.selectAll("#rTip-"+e).style("opacity",1)}function sSearch(e){d3.selectAll(".dot").style("opacity",".25").style("fill",orange),d3.select("#dot-"+e).style("opacity",1).style("fill","#333"),d3.selectAll(".sTooltip").style("opacity",0),d3.selectAll(".sTooltipB").style("opacity",0),d3.selectAll(".sTooltip2").style("opacity",0),d3.selectAll(".sTooltip2B").style("opacity",0),d3.selectAll(".rDot").style("opacity",".025").style("fill","#333"),d3.selectAll(".rTooltip").style("opacity","0"),d3.selectAll(".conn").style("opacity",".05"),d3.selectAll("#sTip-"+e).style("opacity",0),d3.selectAll("#rTip-"+e).style("opacity",0),"zoomedIn"===mapStatus||"none"===mapStatus?d3.selectAll("#sTip-"+e).style("opacity",0):d3.selectAll("#sTip-"+e).style("opacity",1)}var p1Height=$("#p1").height();$(window).scroll(function(e){var s=$(".cd-main-nav-wrapper"),t="fixed"==s.css("position");$(this).scrollTop()>p1Height&&$(".cd-main-nav-wrapper").css({display:"block"}),$(this).scrollTop()<p1Height&&$(".cd-main-nav-wrapper").css({display:"none"})});var category="All Categories",haystack=[];jQuery(document).ready(function($){function e(){return window.getComputedStyle(h.get(0),"::before").getPropertyValue("content").replace(/"/g,"").replace(/'/g,"")}function s(){i||(i=!0,window.requestAnimationFrame?window.requestAnimationFrame(t):setTimeout(t,300))}function t(){var s=e();"desktop"==s&&0==p.siblings(".cd-main-search").length?(n.detach().insertBefore(p),a.detach().insertBefore(n).find(".cd-serch-wrapper").remove()):"mobile"==s&&0!=h.children(".cd-main-nav-wrapper").length&&(n.detach().insertBefore(p),a.detach().insertBefore(n).find(".cd-serch-wrapper").remove()),i=!1}function o(){r.removeClass("search-form-visible"),n.removeClass("is-visible"),d.removeClass("search-form-visible"),$(".cd-search-suggestions").removeClass("cd-search-suggestionsVisible"),$(".cd-search-suggestions").addClass("cd-search-suggestionsInvisible"),$(".newLinks").removeClass("newLinksVisible")}updateHaystack(category);var i=!1,a=$(".cd-main-nav-wrapper"),l=a.children(".cd-main-nav"),n=$(".cd-main-search"),c=$(".cd-main-content"),r=$(".cd-search-trigger"),d=$(".cd-cover-layer"),p=$(".cd-nav-trigger"),h=$(".cd-main-header"),y=$(".cd-search-suggestions"),m=$(".credits-overlay"),u=$(".credits-trigger"),v=$(".credits-exit");!Modernizr.testProp("pointerEvents")&&$("html").addClass("no-pointerevents"),t(),$(window).on("resize",s),r.on("click",function(e){e.preventDefault(),r.hasClass("search-form-visible")?n.find("form").submit():($(".cd-main-header").addClass("cd-main-header-open"),$(".newLinks").addClass("newLinksVisible"),r.addClass("search-form-visible"),d.addClass("search-form-visible"),n.addClass("is-visible").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){n.find('input[type="search"]').focus().end().off("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend")}),$(".p1-search-caption").addClass("p1-search-caption-hide"))}),u.on("click",function(e){e.preventDefault(),m.addClass("credits-overlay-visible"),d.addClass("search-form-visible")}),v.on("click",function(e){o(),m.removeClass("credits-overlay-visible"),d.removeClass("search-form-visible")}),n.on("click",".close",function(){o(),$(".cd-main-header").removeClass("cd-main-header-open"),$(".cd-search-suggestions").removeClass("cd-search-suggestionsVisible"),$(".cd-search-suggestions").addClass("cd-search-suggestionsInvisible"),$(".newLinks").removeClass("newLinksVisible"),$(".p1-search-caption").removeClass("p1-search-caption-hide")}),d.on("click",function(){o(),m.removeClass("credits-overlay-visible"),$(".cd-search-suggestions").removeClass("cd-search-suggestionsVisible"),$(".p1-search-caption").removeClass("p1-search-caption-hide"),$(".cd-search-suggestions").addClass("cd-search-suggestionsInvisible"),$(".newLinks").removeClass("newLinksVisible")}),$(document).keyup(function(e){"27"==e.which&&o()}),n.on("change","select",function(){n.find(".selected-value").text($(this).children("option:selected").text()),category=$(this).children("option:selected").text(),updateHaystack(category)}),n.keyup(function(){runSearch($(this).find("input").val()),$(".newLinks").removeClass("newLinksVisible")})}),$(".o1").on("click",function(e){var s=$(this).find(".oA").text().split(",");optionClick(s[0],s[1],s[2],s[3],s[4])}),$(".o2").on("click",function(e){var s=$(this).find(".oA").text().split(",");optionClick(s[0],s[1],s[2],s[3],s[4])}),$(".o3").on("click",function(e){var s=$(this).find(".oA").text().split(",");optionClick(s[0],s[1],s[2],s[3],s[4])});